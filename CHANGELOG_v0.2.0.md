# LazyBull v0.2.0 更新说明

## 概述

本次更新实现了 6 个核心功能增强，全面提升了 LazyBull 量化回测框架的易用性、准确性和性能。所有代码注释和输出信息均已中文化，提供更友好的使用体验。

## 主要功能

### 1. 特征数据列优化

**背景**: 原有的 `filter_list_days` 字段作为 filter 列不合理，且所有列名都带有 `filter_` 前缀显得冗余。

**改进**:
- 将 `filter_list_days` 改为普通信息列 `list_days`
- filter 列现在只包含 `is_st` 和 `suspend` 两个真正的过滤标记
- 所有输出列去掉 `filter_` 前缀，列名更简洁直观

**影响**: 
- 特征文件现在包含 `is_st`、`suspend`、`list_days` 三个列
- 训练和回测脚本已更新以适配新列名
- 所有测试已更新验证

### 2. 训练模型增加验证集

**功能**: 
- 训练时自动按时间切分训练集和验证集（默认最后 20% 时间作为验证集）
- 训练结束后自动在验证集上评估并打印结果

**指标**:
- MSE（均方误差）
- RMSE（均方根误差）
- R2（决定系数）

**可复现性**: 
- 随机种子固定为 42
- 按时间切分避免未来信息泄漏

**示例输出**:
```
====================================================
验证集评估结果
====================================================
验证集样本数: 12345
MSE（均方误差）: 0.001234
RMSE（均方根误差）: 0.035123
R2（决定系数）: 0.8521
====================================================
```

### 3. 回测进度实时显示

**功能**:
- 回测过程中每 10% 进度或每次调仓打印一次进度
- 显示当前日期、完成百分比、已用时间、预计剩余时间

**示例输出**:
```
回测进度: 10.0% (25/250) | 当前日期: 2023-03-15 | 已用时: 3.5秒 | 预计剩余: 31.5秒
回测进度: 20.0% (50/250) | 当前日期: 2023-05-20 | 已用时: 7.2秒 | 预计剩余: 28.8秒
...
回测完成: 共 250 个交易日, 48 笔交易, 总耗时 36.0秒
```

### 4. 回测报告中文列名

**变更**:

净值曲线 CSV 列名:
- `date` → `日期`
- `portfolio_value` → `组合总值`
- `capital` → `可用资金`
- `market_value` → `持仓市值`
- `nav` → `净值`
- `return` → `收益率`

交易记录 CSV 列名:
- `date` → `交易日期`
- `stock` → `股票代码`
- `action` → `操作` (buy → 买入, sell → 卖出)
- `price` → `成交价格`
- `shares` → `成交股数`
- `amount` → `成交金额`
- `cost` → `交易成本`

**兼容性**: 内部计算仍使用英文列名，仅在输出时转换，保持代码兼容性。

### 5. 特征生成性能优化

**优化点**:
- 使用 pandas `groupby + agg` 替代循环，一次性计算多个统计量
- 使用 `np.where` 替代条件赋值，向量化处理
- 优化列名处理逻辑，正确处理 MultiIndex 列

**效果**: 
- 大幅提升特征生成速度
- 减少内存占用
- 保证计算结果完全一致

**技术细节**:
```python
# 优化前：循环处理每个股票
for ts_code, group in grouped:
    ret_n = (group['close_adj'].iloc[-1] / group['close_adj'].iloc[0]) - 1
    # ... 更多计算

# 优化后：向量化计算
window_features = grouped.agg({
    'close_adj': ['first', 'last', 'mean'],
    'vol': 'mean',
    'amount': 'mean'
})
```

### 6. T+1 交易规则

**重大变更**: 实现更真实的交易规则，避免使用未来信息。

**交易流程**:
1. **T 日**: 根据当日特征生成选股信号（不成交）
2. **T+1 日**: 以 T+1 日收盘价买入信号中的股票
3. **T+n 日**: 以 T+n 日收盘价卖出持仓（n 为持有期）

**持有期设置**:
- 日频调仓: 持有 1 天
- 周频调仓: 持有 5 天
- 月频调仓: 持有 20 天
- 可自定义持有期: `BacktestEngine(..., holding_period=10)`

**边界处理**:
- 回测末期不足 T+1 的信号不会执行买入
- 回测末期不足 T+n 的持仓会在回测结束时自然保留
- 停牌日无法成交的股票会跳过

**技术实现**:
- 使用 `pending_signals` 字典保存待执行的信号
- 持仓结构改为 `{股票: {shares: 数量, buy_date: 日期}}`
- 优化日期查找使用 O(1) 的字典映射

## 性能优化

### 日期查找优化

**问题**: 原有实现使用 `list.index()` 查找日期，时间复杂度 O(n)

**解决**: 创建 `date_to_idx` 映射，查找时间复杂度降为 O(1)

```python
# 创建映射
date_to_idx = {date: idx for idx, date in enumerate(trading_dates)}

# 快速查找
current_idx = date_to_idx.get(date)
```

## 测试覆盖

### 新增测试
- `tests/test_backtest_t1.py`: T+1 交易规则测试（3 个测试用例）
  - 验证 T+1 买入逻辑
  - 验证持有期卖出逻辑
  - 验证信号待执行机制
  - 验证持仓结构

### 更新测试
- `tests/test_features.py`: 更新所有列名引用
  - `filter_is_st` → `is_st`
  - `filter_suspend` → `suspend`
  - 新增 `list_days` 列验证

### 测试结果
```
✅ 特征构建测试: 12/12 通过
✅ ML 模型测试: 9/9 通过
✅ T+1 交易逻辑测试: 3/3 通过
✅ 总计: 24/24 通过
```

## 文档更新

### features_schema.md
- 更新过滤与标记字段说明
- 新增 v0.2.0 变更说明
- 明确 filter 列现在只包含 `is_st` 和 `suspend`

### backtest_assumptions.md
- 新增 v0.2.0 交易规则说明
- 详细说明 T+1 买入、T+n 卖出流程
- 说明边界处理逻辑

### README.md
- 更新功能特性列表
- 新增 v0.2.0 更新内容章节
- 更新 ML 模型特点说明
- 更新版本号为 v0.2.0

## 使用示例

### 训练模型（含验证集）

```bash
# 训练模型，自动切分验证集并评估
python scripts/train_ml_model.py --start-date 20230101 --end-date 20231231
```

### 运行回测（T+1 规则 + 进度显示）

```bash
# 使用 T+1 交易规则运行回测，实时显示进度
python scripts/run_ml_backtest.py --start-date 20230101 --end-date 20231231 \
    --rebalance-freq M --top-n 30
```

### 查看中文报告

```bash
# 生成的 CSV 文件现在使用中文列名
cat data/reports/ml_backtest_nav.csv
# 日期,组合总值,可用资金,持仓市值,净值,收益率
# 2023-01-03,1000000.00,950000.00,50000.00,1.0000,0.0000
# ...

cat data/reports/ml_backtest_trades.csv
# 交易日期,股票代码,操作,成交价格,成交股数,成交金额,交易成本
# 2023-01-04,000001.SZ,买入,12.50,1000,12500.00,3.75
# ...
```

## 兼容性说明

### 破坏性变更
**无**。所有变更保持内部兼容性。

### 需要注意的变更
1. **特征数据列名**: 如果直接读取特征文件，需要使用新列名
2. **回测报告列名**: 如果有脚本解析 CSV 文件，需要更新列名
3. **交易时机**: 回测结果会因为 T+1 规则而有所不同

### 向后兼容
- 所有现有配置文件无需修改
- 所有现有模型文件可继续使用
- 所有 API 接口保持不变

## 升级指南

### 从 v0.1.0 升级到 v0.2.0

1. **更新代码**:
```bash
git pull origin main
```

2. **重新生成特征数据** (可选):
```bash
# 如果需要使用新的列名，重新生成特征
python scripts/build_features.py --start-date 20230101 --end-date 20231231 --force
```

3. **重新训练模型** (推荐):
```bash
# 使用新的验证集功能重新训练
python scripts/train_ml_model.py --start-date 20230101 --end-date 20231231
```

4. **运行回测** (使用新的 T+1 规则):
```bash
# 回测结果会因为 T+1 规则而有所不同
python scripts/run_ml_backtest.py --start-date 20230101 --end-date 20231231
```

## 贡献者

- 核心开发: deltree-y
- 代码审查和优化建议: GitHub Copilot Code Review

## 许可证

MIT License - 详见 LICENSE 文件
