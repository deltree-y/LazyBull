# 分批调仓功能说明

## 概述

分批调仓功能允许将一次完整调仓分散到多个时间点逐步完成，降低冲击成本，平滑交易执行。

## 功能说明

### 使用场景

当目标持仓为 20 只股票时，可以配置为每周只调整其中 5 只，分 4 周完成一次完整调仓。

### 优势

1. **降低冲击成本**: 避免一次性大量交易对价格的影响
2. **平滑执行**: 分散交易时间，降低执行风险
3. **灵活性**: 可根据市场情况动态调整
4. **适应小资金**: 对于资金量较小的账户，可以减少单次交易数量

## 配置说明

在 `configs/base.yaml` 中配置：

```yaml
backtest:
  top_n: 20  # 目标持仓数量
  rebalance_frequency: "M"  # 调仓周期：月度
  
  # 分批调仓配置
  batch_rebalance_enabled: true  # 是否启用分批调仓
  batch_size: 5  # 每批调整的股票数量
  batch_freq: "W"  # 分批频率：W=周度
  batch_strategy: "rank_based"  # 分批策略
```

### 参数说明

| 参数 | 类型 | 默认值 | 说明 |
|-----|------|--------|------|
| `batch_rebalance_enabled` | bool | false | 是否启用分批调仓 |
| `batch_size` | int | 5 | 每批调整的股票数量 |
| `batch_freq` | str | W | 分批频率：D=日，W=周，M=月 |
| `batch_strategy` | str | rank_based | 分批策略，见下文 |

### 分批策略说明

#### 1. rank_based（基于排名）

优先换出当前排名最差的持仓，换入新的高排名标的。

**逻辑**：
- 每批调仓时，比较当前持仓和目标持仓的排名
- 优先卖出当前持仓中排名最差的股票
- 优先买入目标持仓中排名最好的股票

**适用场景**：
- 基于排名的选股策略
- 希望优先优化持仓质量

#### 2. random（随机）

随机选择要调整的持仓。

**逻辑**：
- 从需要调整的持仓中随机选择
- 避免系统性偏差

**适用场景**：
- 避免选择偏差
- 对所有标的一视同仁

#### 3. volatility_based（基于波动率，待实现）

优先调整波动率较高的持仓。

#### 4. weight_based（基于权重，待实现）

优先调整权重偏离目标较大的持仓。

## 使用示例

### 示例1：20只股票分4周调仓

```yaml
backtest:
  top_n: 20  # 目标持仓20只
  rebalance_frequency: "M"  # 每月调仓一次
  
  batch_rebalance_enabled: true
  batch_size: 5  # 每批5只
  batch_freq: "W"  # 每周执行一次
  batch_strategy: "rank_based"
```

**执行流程**：
- 第1周：调整5只（换出最差的5只，换入最好的5只）
- 第2周：调整5只
- 第3周：调整5只
- 第4周：调整5只
- 完成一次完整调仓

### 示例2：10只股票分2周调仓

```yaml
backtest:
  top_n: 10
  rebalance_frequency: "M"
  
  batch_rebalance_enabled: true
  batch_size: 5
  batch_freq: "W"
  batch_strategy: "rank_based"
```

### 示例3：禁用分批调仓（传统方式）

```yaml
backtest:
  top_n: 20
  rebalance_frequency: "M"
  
  batch_rebalance_enabled: false  # 一次性完成调仓
```

### 示例4：Python 代码使用

```python
from src.lazybull.backtest import BacktestEngine

engine = BacktestEngine(
    universe=universe,
    signal=signal,
    initial_capital=500000,
    rebalance_freq="M",  # 月度调仓
    # batch_rebalance_config={  # 待集成到引擎
    #     'enabled': True,
    #     'batch_size': 5,
    #     'batch_freq': 'W',
    #     'batch_strategy': 'rank_based'
    # }
)
```

## 分批调仓流程

### 1. 调仓周期开始

当到达调仓周期（如月初）时：
1. 生成目标持仓列表（如 20 只）
2. 比较当前持仓与目标持仓
3. 确定需要买入和卖出的股票列表
4. 将调仓任务分成多批

### 2. 分批执行

按照 `batch_freq` 的频率（如每周）：
1. 从待调整列表中选择一批股票（`batch_size`）
2. 根据 `batch_strategy` 决定本批调整哪些股票
3. 执行买入和卖出
4. 更新剩余待调整列表

### 3. 完成调仓

当所有批次执行完毕：
1. 持仓达到目标状态
2. 进入下一个调仓周期

## 边界情况处理

### 1. 调仓数量不足

如果需要调整的股票数量少于 `batch_size`：
- 本批只调整实际需要调整的数量
- 不会强制补足到 `batch_size`

**示例**：
- 目标持仓 20 只，当前持仓 18 只
- 只需买入 2 只新股票
- 即使 `batch_size=5`，本次也只调整 2 只

### 2. 目标与当前重叠较多

如果目标持仓与当前持仓重叠度很高：
- 只调整差异部分
- 重叠的股票保持不变

**示例**：
- 目标持仓 20 只，其中 18 只与当前相同
- 只需调整 2 只
- 分批调仓退化为一次性调仓

### 3. 持仓池小于每批数量

如果 `top_n < batch_size`：
- 系统会给出警告
- 分批调仓失去意义，建议禁用

**示例**：
- `top_n=5`, `batch_size=10`
- 警告：分批数量大于持仓数量

### 4. 分批频率过快

如果 `batch_freq` 设置过于频繁：
- 可能在完成一批前就到达下一批时间
- 系统会排队执行

### 5. 市场条件变化

如果分批期间市场条件发生重大变化：
- 已执行的批次不会回退
- 剩余批次继续按原计划执行
- 下一个调仓周期会重新生成目标持仓

## 性能考虑

### 交易成本

分批调仓会：
- **增加交易次数**: 原本一次调仓变为多次
- **可能降低冲击成本**: 避免一次性大量交易
- **总成本**: 需要根据实际情况权衡

### 建议

1. **对于大资金**：分批调仓可以明显降低冲击成本
2. **对于小资金**：交易成本增加可能抵消分批的优势
3. **流动性好的股票**：分批效果不明显
4. **流动性差的股票**：分批调仓更有价值

## 回测报告中的分批信息

启用分批调仓后，回测报告中会包含相关统计：

```
============================================================
回测报告摘要
============================================================
总收益率      : 15.23%
年化收益率    : 15.50%
最大回撤      : -8.45%
波动率        : 12.30%
夏普比率      : 1.25
交易次数      : 96  <-- 增加
  完整调仓周期: 12
  每周期批次  : 4
  单次调仓股数: 5
总交易成本    : 15234.89元  <-- 可能增加
============================================================
```

## 注意事项

1. **与调仓频率的关系**
   - `rebalance_frequency`: 决定何时开始新的调仓周期
   - `batch_freq`: 决定每批之间的间隔
   - `batch_freq` 必须 ≤ `rebalance_frequency`

2. **实盘应用建议**
   - 先在回测中验证效果
   - 小批量开始，逐步增加
   - 监控执行情况，动态调整参数

3. **不适用场景**
   - 持仓数量很少（如 5 只以下）
   - 资金量很小（交易成本占比大）
   - 高频策略（本身已经分散了交易）

## 扩展功能（待实现）

1. **动态批次大小**
   - 根据市场波动率调整批次大小
   - 波动大时减小批次，波动小时增大批次

2. **智能排期**
   - 避开重要财报发布日
   - 避开除权除息日

3. **部分再平衡**
   - 不追求完全达到目标持仓
   - 只调整偏离阈值较大的持仓

4. **与止损的协同**
   - 止损触发后，在下一批次补仓
   - 避免立即补仓造成的冲击

## 相关文档

- [回测假设说明](backtest_assumptions.md)
- [交易成本配置](../configs/base.yaml)
- [调仓频率设置](README.md#调仓频率增强)
