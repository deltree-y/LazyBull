# 成交量过滤功能说明

## 概述

成交量过滤功能用于在**选股时**剔除成交量较低的股票，提高持仓的流动性和可交易性。

**重要**: 成交量过滤仅在信号生成（选股）阶段应用，**不会**在模型训练的特征构建阶段应用。这样可以确保模型训练时包含所有股票数据（包括低流动性股票），使模型能够正确学习和排序。

## 功能说明

### 过滤时机

成交量过滤在以下阶段应用：
- ✅ **信号生成阶段**（MLSignal、其他Signal类）- 选股时过滤
- ❌ **特征构建阶段**（FeatureBuilder）- 不过滤，保留所有股票用于训练

### 过滤逻辑

在信号生成（选股）时：
1. 获取候选股票池
2. 计算所有候选股票的成交量分位数
3. 剔除成交量排名后 N% 的股票（N 可配置）
4. 对剩余股票进行模型预测和排序
5. 选择 Top N 只股票

### 成交量字段

过滤使用以下成交量字段（按优先级）：
1. `vol`: 当日成交量
2. `vol_ma5`: 5日平均成交量（如果配置了 `volume_lookback_days=5`）

## 配置参数

### 在信号生成器中配置

```python
from src.lazybull.signals import MLSignal

signal = MLSignal(
    top_n=20,
    volume_filter_enabled=True,  # 是否启用成交量过滤，默认True
    volume_filter_pct=20.0,  # 过滤后20%，默认20
    volume_lookback_days=5  # 使用5日均量，默认5
)
```

### 参数说明

- **volume_filter_enabled**: 布尔值，是否启用成交量过滤
  - `true`: 启用过滤
  - `false`: 禁用过滤

- **volume_filter_pct**: 浮点数（0-100），过滤阈值百分比
  - 默认值：20（过滤成交量后20%的股票）
  - 取值范围：0-100
  - 0：不过滤任何股票
  - 100：过滤所有股票（慎用）

## 使用示例

### 示例1：使用默认配置（过滤后20%）

```python
from src.lazybull.features import FeatureBuilder

builder = FeatureBuilder(
    min_list_days=60,
    horizon=5,
    volume_filter_pct=20,  # 默认值
    volume_filter_enabled=True  # 默认启用
)
```

### 示例2：自定义过滤比例

```python
# 过滤后30%的股票
builder = FeatureBuilder(
    min_list_days=60,
    horizon=5,
    volume_filter_pct=30,
    volume_filter_enabled=True
)
```

### 示例3：禁用成交量过滤

```python
builder = FeatureBuilder(
    min_list_days=60,
    horizon=5,
    volume_filter_enabled=False
)
```

### 示例4：不过滤（设置为0%）

```python
builder = FeatureBuilder(
    min_list_days=60,
    horizon=5,
    volume_filter_pct=0,
    volume_filter_enabled=True
)
```

## 边界情况处理

### 1. 成交量缺失

成交量为 NaN 或缺失的股票会在过滤时被排除（因为无法计算分位数）。

### 2. 成交量为0

成交量为0的股票会被排除，这些通常是停牌股票，已在Universe层面被过滤。

### 3. 候选股票数量不足

当候选股票数量较少时，成交量过滤可能导致最终可选股票过少。建议根据实际情况调整 `volume_filter_pct` 参数。

### 4. 过滤比例为100%

设置为100%会过滤掉所有股票，导致无可选标的。系统会记录警告日志。

### 5. 特征数据中无成交量字段

如果特征数据中没有 `vol` 或 `vol_maN` 字段，系统会跳过成交量过滤并记录警告。

## 为什么不在特征构建时过滤？

**关键设计原则**: 成交量过滤仅在选股时应用，不在训练时应用。

### 原因

1. **模型需要学习所有股票**: 机器学习模型需要看到"好股票"和"坏股票"的数据，才能学会正确排序
2. **避免训练偏差**: 如果训练时就过滤掉低流动性股票，模型就无法学习识别它们
3. **保持数据完整性**: 训练数据应该包含完整的市场样本，包括流动性差的股票
4. **选股时过滤即可**: 在实际选股时过滤低流动性股票就足够了

### 示例说明

假设有1000只股票：
- 800只流动性好的股票（成交量前80%）
- 200只流动性差的股票（成交量后20%）

**正确做法**（当前实现）：
- 训练时：使用全部1000只股票的数据训练模型
- 选股时：只从800只流动性好的股票中选择

模型能够：
- 学习所有1000只股票的特征
- 正确给200只"坏股票"打低分
- 在800只候选中准确排序

**错误做法**（如果在特征构建时过滤）：
- 训练时：只使用800只流动性好的股票
- 选股时：从800只中选择

模型问题：
- 从未见过200只"坏股票"的数据
- 无法正确识别低流动性股票
- 排序准确性下降

## 日志输出

成交量过滤过程会输出详细日志：

```
[INFO] 成交量过滤: 从450只股票中过滤掉成交量后20%的90只股票, 剩余360只
[INFO] ML排序候选生成: 2023-12-15, 候选数 360, 平均预测分数[0.023], 最高/最低[0.156/-0.089]
```

## 注意事项

1. **仅影响选股**: 成交量过滤只影响选股结果，不影响模型训练
2. **与停牌过滤的关系**: 停牌股票（成交量为0）已在Universe层面被过滤，不会进入成交量过滤逻辑
3. **参数调优**: 建议根据回测结果调整过滤比例
4. **数据质量**: 确保特征数据中包含成交量字段（vol）

## 性能影响

成交量过滤的计算开销很小：
- 计算分位数：O(n log n)
- 过滤操作：O(n)

对整体选股性能影响可忽略不计。

## 相关配置

### 旧版配置（已废弃）

在旧版本中，成交量过滤配置在 `configs/base.yaml` 中：

```yaml
backtest:
  volume_filter_enabled: true
  volume_filter_pct: 20
```

**注意**: 这些配置项已不再使用。现在成交量过滤在信号生成器中配置。

### 迁移指南

如果你之前使用了配置文件中的成交量过滤：

```yaml
# 旧配置（不再使用）
backtest:
  volume_filter_enabled: true
  volume_filter_pct: 20
```

请改为在信号生成器中配置：

```python
# 新配置
signal = MLSignal(
    top_n=20,
    volume_filter_enabled=True,
    volume_filter_pct=20.0
)
```
