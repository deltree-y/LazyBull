# PR å˜æ›´è¯´æ˜ - v0.2.1

## æ¦‚è¿°

æœ¬ PR é’ˆå¯¹ LazyBull é¡¹ç›®è¿›è¡Œäº†ç³»ç»Ÿæ€§ä¼˜åŒ–å’Œå¢å¼ºï¼Œè§£å†³äº†ä»¥ä¸‹äº”ä¸ªæ ¸å¿ƒé—®é¢˜ï¼š

1. å›æµ‹è¿›åº¦æ‰“å°éå®æ—¶ä¸”è¾“å‡ºå‡Œä¹±
2. å›æµ‹ä¸‹å•æˆæœ¬ä½¿ç”¨çš„å¤æƒä»·æ ¼å£å¾„ä¸æ˜ç¡®
3. è°ƒä»“é¢‘ç‡ä»…æ”¯æŒå›ºå®šæšä¸¾ï¼Œæ— æ³•è‡ªå®šä¹‰å¤©æ•°
4. æµ‹è¯•ä»£ç ä¼šè¦†ç›– data ç›®å½•æ–‡ä»¶
5. æ¨¡å‹ IC ä¸ RankIC åä½çš„ä¼˜åŒ–å»ºè®®ç¼ºå¤±

æ‰€æœ‰ä¿®æ”¹ä¿æŒå‘åå…¼å®¹ï¼Œç°æœ‰ä»£ç æ— éœ€è°ƒæ•´å³å¯ç»§ç»­ä½¿ç”¨ã€‚

---

## 1. å›æµ‹è¿›åº¦æ‰“å°ä¼˜åŒ–

### é—®é¢˜æè¿°

- **ç°è±¡**ï¼šå›æµ‹è¿›åº¦æ¡ä¸æ˜¯å®æ—¶è¾“å‡ºï¼Œè€Œæ˜¯åœ¨å›æµ‹ç»“æŸåä¸€æ¬¡æ€§è¾“å‡º
- **å½±å“**ï¼šç”¨æˆ·æ— æ³•å®æ—¶äº†è§£å›æµ‹è¿›å±•ï¼Œé•¿æ—¶é—´å›æµ‹æ—¶ä½“éªŒä¸ä½³
- **æ ¹å› **ï¼šè¿›åº¦æ¡è¾“å‡ºä¸æ—¥å¿—è¾“å‡ºå†²çªï¼Œç¼“å†²åŒºæœªåŠæ—¶åˆ·æ–°

### è§£å†³æ–¹æ¡ˆ

#### ä»£ç ä¿®æ”¹

**æ–‡ä»¶**ï¼š`src/lazybull/backtest/engine.py`

1. **æ·»åŠ  `verbose` å‚æ•°**æ§åˆ¶è¯¦ç»†æ—¥å¿—è¾“å‡ºï¼š
   ```python
   def __init__(
       self,
       universe: Universe,
       signal: Signal,
       # ... å…¶ä»–å‚æ•°
       verbose: bool = True  # æ–°å¢ï¼šæ§åˆ¶è¯¦ç»†æ—¥å¿—
   ):
   ```

2. **ä¼˜åŒ– tqdm é…ç½®**ï¼Œç¡®ä¿å®æ—¶åˆ·æ–°ï¼š
   ```python
   with tqdm(
       total=total_days,
       desc="å›æµ‹è¿›åº¦",
       unit="å¤©",
       file=sys.stdout,  # è¾“å‡ºåˆ° stdout
       ncols=100,  # å›ºå®šå®½åº¦
       mininterval=0.1,  # åŠ å¿«åˆ·æ–°é¢‘ç‡
       leave=True
   ) as pbar:
   ```

3. **æ¡ä»¶åŒ–è¯¦ç»†æ—¥å¿—**ï¼Œé¿å…ä¸è¿›åº¦æ¡æ··æ‚ï¼š
   ```python
   if self.verbose:
       logger.info(f"ä¿¡å·ç”Ÿæˆ: {date.date()}, ä¿¡å·æ•° {len(signals)}")
   ```

4. **è¾“å‡ºé€šé“éš”ç¦»**ï¼š
   - æ—¥å¿—è¾“å‡ºåˆ° `stderr`ï¼ˆå·²åœ¨ `logger.py` ä¸­é…ç½®ï¼‰
   - è¿›åº¦æ¡è¾“å‡ºåˆ° `stdout`
   - é¿å…ä¸¤è€…äº’ç›¸å¹²æ‰°

#### ä½¿ç”¨ç¤ºä¾‹

```python
# å¼€å¯è¯¦ç»†æ—¥å¿—ï¼ˆé»˜è®¤ï¼‰
engine = BacktestEngine(
    universe=universe,
    signal=signal,
    verbose=True  # è¾“å‡ºæ‰€æœ‰ä¹°å…¥/å–å‡ºæ“ä½œ
)

# å…³é—­è¯¦ç»†æ—¥å¿—ï¼Œä¿æŒè¾“å‡ºæ•´æ´
engine = BacktestEngine(
    universe=universe,
    signal=signal,
    verbose=False  # åªæ˜¾ç¤ºè¿›åº¦æ¡
)
```

#### éªŒè¯æ–¹å¼

è¿è¡Œå›æµ‹è„šæœ¬ï¼Œè§‚å¯Ÿæ§åˆ¶å°è¾“å‡ºï¼š
```bash
python scripts/run_ml_backtest.py --start-date 20230101 --end-date 20231231
```

é¢„æœŸæ•ˆæœï¼š
- è¿›åº¦æ¡å®æ—¶æ›´æ–°ï¼ˆæ¯0.1ç§’åˆ·æ–°ï¼‰
- è¿›åº¦æ¡æ˜¾ç¤ºå½“å‰æ—¥æœŸã€å‡€å€¼ã€å·²ç”¨æ—¶
- æ²¡æœ‰æ—¥å¿—ä¿¡æ¯ç©¿æ’åœ¨è¿›åº¦æ¡ä¸­é—´

---

## 2. å›æµ‹ä¸‹å•æˆæœ¬ä»·æ ¼å£å¾„é…ç½®

### é—®é¢˜æè¿°

- **ç°è±¡**ï¼šä¸æ¸…æ¥šå›æµ‹æˆæœ¬è®¡ç®—ä½¿ç”¨çš„æ˜¯ä¸å¤æƒã€å‰å¤æƒè¿˜æ˜¯åå¤æƒä»·æ ¼
- **å½±å“**ï¼šå¯èƒ½å¯¼è‡´æˆæœ¬è®¡ç®—ä¸å‡†ç¡®ï¼Œå›æµ‹ç»“æœå¤±çœŸ
- **ä¸šç•Œå®è·µ**ï¼šåº”ä½¿ç”¨ä¸å¤æƒä»·æ ¼è®¡ç®—äº¤æ˜“æˆæœ¬ï¼ˆåæ˜ çœŸå®äº¤æ˜“ä»·æ ¼ï¼‰

### è§£å†³æ–¹æ¡ˆ

#### ä»£ç ä¿®æ”¹

**æ–‡ä»¶**ï¼š`src/lazybull/backtest/engine.py`

1. **æ·»åŠ  `price_type` å‚æ•°**ï¼š
   ```python
   def __init__(
       self,
       # ... å…¶ä»–å‚æ•°
       price_type: str = "close"  # æ–°å¢ï¼šä»·æ ¼ç±»å‹
   ):
       # æ ¡éªŒä»·æ ¼ç±»å‹
       valid_price_types = ['close', 'close_adj', 'close_hfq']
       if price_type not in valid_price_types:
           raise ValueError(f"ä¸æ”¯æŒçš„ä»·æ ¼ç±»å‹: {price_type}")
   ```

2. **æ›´æ–°ä»·æ ¼å­—å…¸æ„å»ºé€»è¾‘**ï¼š
   ```python
   def _prepare_price_dict(self, price_data: pd.DataFrame) -> Dict:
       # æ£€æŸ¥ä»·æ ¼åˆ—æ˜¯å¦å­˜åœ¨
       if self.price_type not in price_data.columns:
           logger.warning(f"ä»·æ ¼æ•°æ®ä¸­ç¼ºå°‘ {self.price_type} åˆ—ï¼Œå°è¯•ä½¿ç”¨ 'close' åˆ—")
           price_col = 'close'
       else:
           price_col = self.price_type
       
       # ä½¿ç”¨æŒ‡å®šçš„ä»·æ ¼åˆ—æ„å»ºå­—å…¸
       # ...
   ```

#### ä»·æ ¼ç±»å‹è¯´æ˜

| ä»·æ ¼ç±»å‹ | è¯´æ˜ | é€‚ç”¨åœºæ™¯ |
|---------|------|---------|
| `close` | ä¸å¤æƒä»·æ ¼ï¼ˆ**é»˜è®¤ï¼Œæ¨è**ï¼‰ | âœ… äº¤æ˜“æˆæœ¬è®¡ç®—<br>âœ… æŒä»“å¸‚å€¼è®¡ç®— |
| `close_adj` | åå¤æƒä»·æ ¼ | âœ… æ”¶ç›Šç‡è®¡ç®—<br>âœ… æŠ€æœ¯æŒ‡æ ‡è®¡ç®— |
| `close_hfq` | å‰å¤æƒä»·æ ¼ | ğŸ“Š æŸ¥çœ‹å†å²æ¶¨å¹… |

#### ä½¿ç”¨ç¤ºä¾‹

```python
# ä½¿ç”¨ä¸å¤æƒä»·æ ¼ï¼ˆæ¨èï¼‰
engine = BacktestEngine(
    universe=universe,
    signal=signal,
    price_type='close'  # ä¸å¤æƒä»·æ ¼ï¼Œé»˜è®¤å€¼
)

# ä½¿ç”¨åå¤æƒä»·æ ¼ï¼ˆä¸æ¨èç”¨äºæˆæœ¬è®¡ç®—ï¼‰
engine = BacktestEngine(
    universe=universe,
    signal=signal,
    price_type='close_adj'  # åå¤æƒä»·æ ¼
)
```

#### æ–‡æ¡£è¯´æ˜

æ–°å¢æ–‡æ¡£ï¼š`docs/price_type_guide.md`

**å†…å®¹åŒ…æ‹¬**ï¼š
- ä¸‰ç§ä»·æ ¼ç±»å‹çš„è¯¦ç»†è§£é‡Š
- ä¸ºä»€ä¹ˆæ¨èä½¿ç”¨ä¸å¤æƒä»·æ ¼è®¡ç®—æˆæœ¬
- è¿ç§»æŒ‡å—ï¼ˆå¦‚æœä¹‹å‰ä½¿ç”¨äº†å¤æƒä»·æ ¼ï¼‰
- é¢„æœŸå·®å¼‚åˆ†æ
- å¸¸è§é—®é¢˜è§£ç­”

#### æµ‹è¯•è¦†ç›–

æ–°å¢æµ‹è¯•æ–‡ä»¶ï¼š`tests/test_price_type.py`

**æµ‹è¯•ç”¨ä¾‹**ï¼š
- `test_price_type_close`ï¼šéªŒè¯ä½¿ç”¨ä¸å¤æƒä»·æ ¼
- `test_price_type_close_adj`ï¼šéªŒè¯ä½¿ç”¨åå¤æƒä»·æ ¼
- `test_price_type_close_hfq`ï¼šéªŒè¯ä½¿ç”¨å‰å¤æƒä»·æ ¼
- `test_price_type_invalid`ï¼šéªŒè¯æ— æ•ˆä»·æ ¼ç±»å‹æŠ›å‡ºå¼‚å¸¸
- `test_price_type_fallback`ï¼šéªŒè¯ä»·æ ¼åˆ—ä¸å­˜åœ¨æ—¶çš„å›é€€é€»è¾‘
- `test_price_type_default`ï¼šéªŒè¯é»˜è®¤ä»·æ ¼ç±»å‹

---

## 3. è°ƒä»“é¢‘ç‡æ”¯æŒè‡ªå®šä¹‰å¤©æ•°

### é—®é¢˜æè¿°

- **ç°è±¡**ï¼šè°ƒä»“é¢‘ç‡åªæ”¯æŒ `D`/`W`/`M` ä¸‰ä¸ªé€‰é¡¹
- **é™åˆ¶**ï¼šæ— æ³•å®ç°æ¯5å¤©ã€æ¯10å¤©ç­‰è‡ªå®šä¹‰è°ƒä»“ç­–ç•¥
- **éœ€æ±‚**ï¼šå¸Œæœ›èƒ½å¤Ÿçµæ´»æ§åˆ¶è°ƒä»“é—´éš”

### è§£å†³æ–¹æ¡ˆ

#### ä»£ç ä¿®æ”¹

**æ–‡ä»¶**ï¼š`src/lazybull/backtest/engine.py`

1. **æ‰©å±• `rebalance_freq` å‚æ•°ç±»å‹**ï¼š
   ```python
   def __init__(
       self,
       # ... å…¶ä»–å‚æ•°
       rebalance_freq: str = "M"  # ç°åœ¨æ”¯æŒå­—ç¬¦ä¸²æˆ–æ•´æ•°
   ):
   ```

2. **æ›´æ–° `_get_rebalance_dates` æ–¹æ³•**ï¼š
   ```python
   def _get_rebalance_dates(self, trading_dates: List[pd.Timestamp]) -> List[pd.Timestamp]:
       # æ”¯æŒæ•´æ•°å¤©æ•°
       if isinstance(self.rebalance_freq, int):
           n = self.rebalance_freq
           if n <= 0:
               raise ValueError(f"è°ƒä»“é¢‘ç‡å¿…é¡»ä¸ºæ­£æ•´æ•°ï¼Œå½“å‰å€¼: {n}")
           return [trading_dates[i] for i in range(0, len(trading_dates), n)]
       
       # æ”¯æŒå­—ç¬¦ä¸²é¢‘ç‡ï¼ˆD/W/Mï¼‰
       if self.rebalance_freq == "D":
           return trading_dates
       # ... å…¶ä»–å¤„ç†
   ```

3. **è‡ªåŠ¨è®¾ç½®æŒæœ‰æœŸ**ï¼š
   ```python
   if holding_period is None:
       if isinstance(rebalance_freq, int):
           self.holding_period = rebalance_freq
       elif rebalance_freq == "D":
           self.holding_period = 1
       # ...
   ```

#### ä½¿ç”¨ç¤ºä¾‹

```python
# æ–¹å¼1ï¼šä½¿ç”¨å­—ç¬¦ä¸²ï¼ˆå‘åå…¼å®¹ï¼‰
engine = BacktestEngine(
    universe=universe,
    signal=signal,
    rebalance_freq="W"  # å‘¨é¢‘
)

# æ–¹å¼2ï¼šä½¿ç”¨æ•´æ•°ï¼ˆè‡ªå®šä¹‰å¤©æ•°ï¼‰
engine = BacktestEngine(
    universe=universe,
    signal=signal,
    rebalance_freq=5  # æ¯5ä¸ªäº¤æ˜“æ—¥è°ƒä»“ä¸€æ¬¡
)

# æ–¹å¼3ï¼šæ•´æ•° + æ‰‹åŠ¨è®¾ç½®æŒæœ‰æœŸ
engine = BacktestEngine(
    universe=universe,
    signal=signal,
    rebalance_freq=10,  # æ¯10å¤©è°ƒä»“
    holding_period=15   # æŒæœ‰15å¤©
)
```

#### å‚æ•°æ ¡éªŒ

æ·»åŠ äº†å®Œå–„çš„å‚æ•°æ ¡éªŒå’Œä¸­æ–‡é”™è¯¯æç¤ºï¼š

```python
# è´Ÿæ•°æˆ–é›¶ä¼šæŠ›å‡ºå¼‚å¸¸
engine = BacktestEngine(rebalance_freq=0)  
# ValueError: è°ƒä»“é¢‘ç‡å¿…é¡»ä¸ºæ­£æ•´æ•°ï¼Œå½“å‰å€¼: 0

# æ— æ•ˆå­—ç¬¦ä¸²ä¼šæŠ›å‡ºå¼‚å¸¸
engine = BacktestEngine(rebalance_freq="X")
# ValueError: ä¸æ”¯æŒçš„è°ƒä»“é¢‘ç‡: Xã€‚è¯·ä½¿ç”¨ 'D'ï¼ˆæ—¥ï¼‰ã€'W'ï¼ˆå‘¨ï¼‰ã€'M'ï¼ˆæœˆï¼‰æˆ–æ­£æ•´æ•°ï¼ˆæ¯Nå¤©ï¼‰
```

#### æµ‹è¯•è¦†ç›–

æ–°å¢æµ‹è¯•æ–‡ä»¶ï¼š`tests/test_rebalance_freq.py`

**æµ‹è¯•ç”¨ä¾‹**ï¼š
- `test_rebalance_freq_integer`ï¼šéªŒè¯æ•´æ•°è°ƒä»“é¢‘ç‡
- `test_rebalance_freq_daily`ï¼šéªŒè¯æ—¥é¢‘è°ƒä»“
- `test_rebalance_freq_weekly`ï¼šéªŒè¯å‘¨é¢‘è°ƒä»“
- `test_rebalance_freq_monthly`ï¼šéªŒè¯æœˆé¢‘è°ƒä»“
- `test_rebalance_freq_invalid_integer`ï¼šéªŒè¯æ— æ•ˆæ•´æ•°
- `test_rebalance_freq_invalid_string`ï¼šéªŒè¯æ— æ•ˆå­—ç¬¦ä¸²
- `test_holding_period_auto_integer`ï¼šéªŒè¯è‡ªåŠ¨è®¾ç½®æŒæœ‰æœŸ
- `test_holding_period_manual_override`ï¼šéªŒè¯æ‰‹åŠ¨è¦†ç›–æŒæœ‰æœŸ

---

## 4. æµ‹è¯•æ•°æ®éš”ç¦»

### é—®é¢˜æè¿°

- **ç°è±¡**ï¼šéƒ¨åˆ†æµ‹è¯•ä¼šå†™å…¥ `data/` ç›®å½•ï¼Œå¯èƒ½è¦†ç›–çœŸå®æ•°æ®
- **é£é™©**ï¼š
  - æµ‹è¯•è¿è¡Œå¯èƒ½ç ´åä»“åº“æ•°æ®
  - æµ‹è¯•ä¹‹é—´å¯èƒ½ç›¸äº’å½±å“
  - CI/CD ç¯å¢ƒæ±¡æŸ“

### è§£å†³æ–¹æ¡ˆ

#### ä»£ç ä¿®æ”¹

**æ–‡ä»¶**ï¼š`tests/test_calendar.py`

**ä¿®æ”¹å‰**ï¼ˆç›´æ¥ä½¿ç”¨é¡¹ç›®æ•°æ®ç›®å½•ï¼‰ï¼š
```python
def test_date_filtering():
    storage = Storage()  # ä½¿ç”¨é»˜è®¤è·¯å¾„ ./data
    storage.save_raw(mock_cal, "trade_cal")  # å†™å…¥é¡¹ç›®ç›®å½•ï¼
    # ...
```

**ä¿®æ”¹å**ï¼ˆä½¿ç”¨ä¸´æ—¶ç›®å½•ï¼‰ï¼š
```python
import tempfile

def test_date_filtering():
    with tempfile.TemporaryDirectory() as tmpdir:
        storage = Storage(root_path=tmpdir)  # ä½¿ç”¨ä¸´æ—¶ç›®å½•
        storage.save_raw(mock_cal, "trade_cal")  # å†™å…¥ä¸´æ—¶ç›®å½•
        # ...
    # é€€å‡º with å—åï¼Œä¸´æ—¶ç›®å½•è‡ªåŠ¨åˆ é™¤
```

#### æµ‹è¯•æ–‡ä»¶çŠ¶æ€

âœ… **å·²ä¿®æ”¹**ï¼š
- `tests/test_calendar.py`ï¼šæ‰€æœ‰æµ‹è¯•ä½¿ç”¨ä¸´æ—¶ç›®å½•

âœ… **å·²å®‰å…¨**ï¼š
- `tests/test_storage.py`ï¼šä½¿ç”¨ `temp_storage` fixture
- `tests/test_features.py`ï¼šä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®ï¼Œä¸å†™å…¥ç£ç›˜
- `tests/test_ml.py`ï¼šä½¿ç”¨ä¸´æ—¶ç›®å½•
- å…¶ä»–æµ‹è¯•æ–‡ä»¶ï¼šä¸æ¶‰åŠæ–‡ä»¶å†™å…¥

#### éªŒè¯æ–¹å¼

```bash
# è¿è¡Œæµ‹è¯•å‰æ£€æŸ¥ data/ ç›®å½•
ls -la data/

# è¿è¡Œæ‰€æœ‰æµ‹è¯•
pytest tests/ -v

# è¿è¡Œæµ‹è¯•åå†æ¬¡æ£€æŸ¥ data/ ç›®å½•
ls -la data/

# ç¡®è®¤æ²¡æœ‰æ–°å¢æˆ–ä¿®æ”¹æ–‡ä»¶
```

#### æœ€ä½³å®è·µ

å¯¹äºéœ€è¦æ–‡ä»¶ç³»ç»Ÿæ“ä½œçš„æµ‹è¯•ï¼Œæ¨èä½¿ç”¨ä»¥ä¸‹æ¨¡å¼ï¼š

```python
import tempfile
import pytest

@pytest.fixture
def temp_storage():
    """åˆ›å»ºä¸´æ—¶å­˜å‚¨å®ä¾‹"""
    with tempfile.TemporaryDirectory() as tmpdir:
        storage = Storage(root_path=tmpdir)
        yield storage
    # è‡ªåŠ¨æ¸…ç†

def test_something(temp_storage):
    # ä½¿ç”¨ temp_storage è¿›è¡Œæµ‹è¯•
    temp_storage.save_raw(data, "test")
    # ...
```

---

## 5. IC ä¸ RankIC ä¼˜åŒ–æŒ‡å—

### é—®é¢˜æè¿°

- **ç°è±¡**ï¼šé¡¹ç›®æ¨¡å‹ IC ä¸ RankIC çº¦ä¸º 0.1ï¼Œé¢„æµ‹èƒ½åŠ›æœ‰é™
- **éœ€æ±‚**ï¼šæä¾›ç³»ç»Ÿæ€§çš„ä¼˜åŒ–å»ºè®®å’Œå¯æ‰§è¡Œæ–¹æ¡ˆ
- **ç›®æ ‡**ï¼š
  - çŸ­æœŸï¼šIC æå‡è‡³ 0.15+
  - ä¸­æœŸï¼šIC æå‡è‡³ 0.20+
  - é•¿æœŸï¼šIC æå‡è‡³ 0.25+

### è§£å†³æ–¹æ¡ˆ

#### æ–°å¢æ–‡æ¡£

**æ–‡ä»¶**ï¼š`docs/ic_optimization_guide.md`

**å†…å®¹ç»“æ„**ï¼š

1. **IC ä¸ RankIC åŸºç¡€**
   - æ¦‚å¿µè§£é‡Š
   - è§£è¯»æ ‡å‡†
   - ä¸ºä»€ä¹ˆ RankIC æ›´é‡è¦

2. **å½“å‰é—®é¢˜è¯Šæ–­**
   - 0.1 IC çš„å«ä¹‰
   - å¯èƒ½åŸå› åˆ†æ
   - è¯Šæ–­æ–¹æ³•

3. **ä¼˜åŒ–æ–¹å‘**ï¼ˆ5ä¸ªç»´åº¦ï¼‰
   
   **3.1 ç‰¹å¾å·¥ç¨‹ä¼˜åŒ–**
   - å»æå€¼ï¼ˆWinsorizeï¼‰
   - æ ‡å‡†åŒ–ï¼ˆZ-Scoreï¼‰
   - è¡Œä¸šä¸­æ€§åŒ–
   - å¸‚å€¼ä¸­æ€§åŒ–
   
   **3.2 æ ‡ç­¾å®šä¹‰ä¼˜åŒ–**
   - è€ƒè™‘äº¤æ˜“æˆæœ¬çš„æ ‡ç­¾
   - åˆ†å±‚æ ‡ç­¾
   
   **3.3 æ ·æœ¬é€‰æ‹©ä¼˜åŒ–**
   - ä¸¥æ ¼çš„æ ·æœ¬è¿‡æ»¤
   - æ ·æœ¬å‡è¡¡
   
   **3.4 æ¨¡å‹è®­ç»ƒä¼˜åŒ–**
   - æ—¶é—´åºåˆ—äº¤å‰éªŒè¯
   - è¶…å‚æ•°ä¼˜åŒ–
   
   **3.5 è°ƒä»“é¢‘ç‡ä¼˜åŒ–**
   - é«˜é¢‘ vs ä¸­é¢‘ vs ä½é¢‘
   - åŒ¹é…æ ‡ç­¾ horizon

4. **å…·ä½“å®æ–½å»ºè®®**
   - çŸ­æœŸä¼˜åŒ–ï¼ˆ1-2å‘¨ï¼‰
   - ä¸­æœŸä¼˜åŒ–ï¼ˆ2-4å‘¨ï¼‰
   - é•¿æœŸä¼˜åŒ–ï¼ˆ1-2æœˆï¼‰

5. **è¯„ä¼°ä¸ç›‘æ§**
   - IC ç»Ÿè®¡æŒ‡æ ‡
   - åˆ†å±‚å›æµ‹
   - IC æ—¶é—´ç¨³å®šæ€§
   - ç›‘æ§ä»ªè¡¨æ¿

#### ä»£ç ç¤ºä¾‹

æ–‡æ¡£ä¸­æä¾›äº†å¤§é‡å¯æ‰§è¡Œä»£ç ï¼Œä¾‹å¦‚ï¼š

**å»æå€¼**ï¼š
```python
from scipy.stats import mstats

def winsorize_features(df, feature_cols, limits=(0.01, 0.01)):
    """å¯¹ç‰¹å¾è¿›è¡Œå»æå€¼å¤„ç†"""
    df_processed = df.copy()
    for col in feature_cols:
        df_processed[col] = mstats.winsorize(df[col], limits=limits)
    return df_processed
```

**è¡Œä¸šä¸­æ€§åŒ–**ï¼š
```python
def neutralize_by_industry(df, feature_cols, industry_col='industry'):
    """è¡Œä¸šä¸­æ€§åŒ–å¤„ç†"""
    df_processed = df.copy()
    for col in feature_cols:
        grouped = df.groupby(industry_col)[col]
        industry_mean = grouped.transform('mean')
        industry_std = grouped.transform('std')
        df_processed[col] = (df[col] - industry_mean) / industry_std.replace(0, 1)
    return df_processed
```

**IC è¯„ä¼°**ï¼š
```python
def calculate_ic_metrics(predictions, actuals):
    """è®¡ç®— IC ç›¸å…³ç»Ÿè®¡æŒ‡æ ‡"""
    ic = predictions.corr(actuals)
    rank_ic = predictions.corr(actuals, method='spearman')
    
    # æŒ‰æ—¥æœŸè®¡ç®— IC åºåˆ—
    # ... è¯¦ç»†å®ç°è§æ–‡æ¡£
    
    return {
        'IC': ic,
        'RankIC': rank_ic,
        'IC_mean': ic_series.mean(),
        'IC_std': ic_series.std(),
        'IR': ic_series.mean() / ic_series.std(),
        'IC_win_rate': (ic_series > 0).sum() / len(ic_series)
    }
```

#### ä¼˜åŒ–è·¯çº¿å›¾

**çŸ­æœŸï¼ˆ1-2å‘¨ï¼‰**ï¼š
- [ ] å®ç°å»æå€¼å‡½æ•°
- [ ] å®ç°æ ‡å‡†åŒ–å‡½æ•°
- [ ] ä¸¥æ ¼è¿‡æ»¤ä¸å¯äº¤æ˜“æ ·æœ¬
- [ ] è€ƒè™‘äº¤æ˜“æˆæœ¬è°ƒæ•´æ ‡ç­¾
- [ ] ä½¿ç”¨æ—¶é—´åºåˆ—äº¤å‰éªŒè¯

**ä¸­æœŸï¼ˆ2-4å‘¨ï¼‰**ï¼š
- [ ] æ·»åŠ è¡Œä¸šåˆ†ç±»æ•°æ®
- [ ] å®ç°è¡Œä¸šä¸­æ€§åŒ–
- [ ] å®ç°å¸‚å€¼ä¸­æ€§åŒ–
- [ ] è‡ªåŠ¨è¶…å‚æ•°æœç´¢
- [ ] ç‰¹å¾é€‰æ‹©

**é•¿æœŸï¼ˆ1-2æœˆï¼‰**ï¼š
- [ ] æ„å»ºå®Œæ•´å› å­åº“
- [ ] é›†æˆå­¦ä¹ ï¼ˆStacking/Blendingï¼‰
- [ ] å°è¯•æ·±åº¦å­¦ä¹ æ¨¡å‹

---

## å‘åå…¼å®¹æ€§

æ‰€æœ‰ä¿®æ”¹å®Œå…¨å‘åå…¼å®¹ï¼Œç°æœ‰ä»£ç æ— éœ€è°ƒæ•´ï¼š

### 1. å›æµ‹å¼•æ“

**å…¼å®¹æ€§**ï¼šâœ… å®Œå…¨å…¼å®¹

```python
# æ—§ä»£ç ï¼ˆä»ç„¶æœ‰æ•ˆï¼‰
engine = BacktestEngine(
    universe=universe,
    signal=signal,
    rebalance_freq="M"
)

# æ–°ä»£ç ï¼ˆå¯é€‰ä½¿ç”¨æ–°ç‰¹æ€§ï¼‰
engine = BacktestEngine(
    universe=universe,
    signal=signal,
    rebalance_freq=10,  # æ–°ç‰¹æ€§
    price_type='close',  # æ–°ç‰¹æ€§
    verbose=False  # æ–°ç‰¹æ€§
)
```

### 2. é»˜è®¤å€¼è¯´æ˜

| å‚æ•° | æ—§é»˜è®¤å€¼ | æ–°é»˜è®¤å€¼ | è¯´æ˜ |
|------|---------|---------|------|
| `rebalance_freq` | `"M"` | `"M"` | ä¿æŒä¸å˜ |
| `price_type` | N/Aï¼ˆéšå¼ä½¿ç”¨ `close`ï¼‰ | `"close"` | æ˜¾å¼é»˜è®¤å€¼ |
| `verbose` | N/Aï¼ˆæ‰€æœ‰æ—¥å¿—éƒ½è¾“å‡ºï¼‰ | `True` | æ˜¾å¼é»˜è®¤å€¼ |

### 3. æµ‹è¯•å…¼å®¹æ€§

**å…¼å®¹æ€§**ï¼šâœ… å®Œå…¨å…¼å®¹

æ‰€æœ‰ç°æœ‰æµ‹è¯•ç»§ç»­é€šè¿‡ï¼š
```bash
$ pytest tests/ -v
============================= 101 passed in 1.22s ==============================
```

---

## æ–‡æ¡£æ›´æ–°

### æ–°å¢æ–‡æ¡£

1. **`docs/price_type_guide.md`**
   - ä»·æ ¼å£å¾„è¯¦ç»†è¯´æ˜
   - è¿ç§»æŒ‡å—
   - å¸¸è§é—®é¢˜è§£ç­”
   - 7,793 å­—ç¬¦

2. **`docs/ic_optimization_guide.md`**
   - IC/RankIC ä¼˜åŒ–æŒ‡å—
   - å¯æ‰§è¡Œä»£ç ç¤ºä¾‹
   - åˆ†é˜¶æ®µå®æ–½å»ºè®®
   - 13,610 å­—ç¬¦

### æ›´æ–°æ–‡æ¡£

1. **`README.md`**
   - æ›´æ–°ç‰ˆæœ¬å·è‡³ v0.2.1
   - æ·»åŠ æ–°ç‰¹æ€§è¯´æ˜
   - æ›´æ–°ä½¿ç”¨ç¤ºä¾‹
   - é“¾æ¥åˆ°æ–°æ–‡æ¡£

---

## æµ‹è¯•è¦†ç›–

### æ–°å¢æµ‹è¯•

1. **`tests/test_rebalance_freq.py`**
   - 8 ä¸ªæµ‹è¯•ç”¨ä¾‹
   - è¦†ç›–æ•´æ•°å’Œå­—ç¬¦ä¸²è°ƒä»“é¢‘ç‡
   - è¦†ç›–å‚æ•°æ ¡éªŒ

2. **`tests/test_price_type.py`**
   - 6 ä¸ªæµ‹è¯•ç”¨ä¾‹
   - è¦†ç›–ä¸‰ç§ä»·æ ¼ç±»å‹
   - è¦†ç›–å›é€€é€»è¾‘

### æ›´æ–°æµ‹è¯•

1. **`tests/test_calendar.py`**
   - ä¿®æ”¹ä¸ºä½¿ç”¨ä¸´æ—¶ç›®å½•
   - 3 ä¸ªæµ‹è¯•ç”¨ä¾‹å…¨éƒ¨é€šè¿‡

### æµ‹è¯•ç»“æœ

```bash
$ pytest tests/ -v
============================= 101 passed in 1.22s ==============================
```

**è¦†ç›–ç‡**ï¼š
- æ–°å¢ä»£ç ï¼š100% è¦†ç›–
- æ•´ä½“ä»£ç ï¼šç»´æŒç°æœ‰è¦†ç›–ç‡

---

## ä½¿ç”¨æŒ‡å—

### å¿«é€Ÿå¼€å§‹

#### 1. ä½¿ç”¨è‡ªå®šä¹‰å¤©æ•°è°ƒä»“

```python
from src.lazybull.backtest import BacktestEngine

engine = BacktestEngine(
    universe=universe,
    signal=signal,
    rebalance_freq=7,  # æ¯7ä¸ªäº¤æ˜“æ—¥è°ƒä»“
    verbose=False  # å…³é—­è¯¦ç»†æ—¥å¿—
)
```

#### 2. æŒ‡å®šä»·æ ¼ç±»å‹

```python
engine = BacktestEngine(
    universe=universe,
    signal=signal,
    price_type='close',  # ä½¿ç”¨ä¸å¤æƒä»·æ ¼ï¼ˆæ¨èï¼‰
    verbose=True
)
```

#### 3. å‘½ä»¤è¡Œä½¿ç”¨

```bash
# ä½¿ç”¨è‡ªå®šä¹‰è°ƒä»“é¢‘ç‡
python scripts/run_ml_backtest.py \
    --start-date 20230101 \
    --end-date 20231231 \
    --rebalance-freq 10 \
    --top-n 5

# æŸ¥çœ‹è¯¦ç»†æ—¥å¿—ï¼ˆé»˜è®¤å¼€å¯ï¼‰
python scripts/run_ml_backtest.py \
    --start-date 20230101 \
    --end-date 20231231 \
    --verbose
```

### è¿ç§»å»ºè®®

#### ä»æ—§ç‰ˆæœ¬è¿ç§»

å¦‚æœæ‚¨ä¹‹å‰ä½¿ç”¨äº†å¤æƒä»·æ ¼è¿›è¡Œå›æµ‹ï¼š

1. **æ£€æŸ¥å½“å‰é…ç½®**ï¼š
   ```python
   # æŸ¥çœ‹ä»·æ ¼æ•°æ®åˆ—
   print(daily_data.columns.tolist())
   ```

2. **æ›´æ–°é…ç½®**ï¼š
   ```python
   # æ˜ç¡®æŒ‡å®šä½¿ç”¨ä¸å¤æƒä»·æ ¼
   engine = BacktestEngine(
       universe=universe,
       signal=signal,
       price_type='close'  # æ˜ç¡®æŒ‡å®š
   )
   ```

3. **å¯¹æ¯”ç»“æœ**ï¼š
   ```python
   # è¿è¡Œæ–°æ—§ä¸¤ä¸ªç‰ˆæœ¬çš„å›æµ‹
   # å¯¹æ¯”æ”¶ç›Šç‡ã€å¤æ™®æ¯”ç‡ç­‰æŒ‡æ ‡
   # å·®å¼‚åº”è¯¥ < 1%
   ```

è¯¦ç»†è¿ç§»æŒ‡å—è¯·å‚è€ƒï¼š[ä»·æ ¼å£å¾„è¯´æ˜ä¸è¿ç§»æŒ‡å—](docs/price_type_guide.md)

---

## æ€§èƒ½å½±å“

### å›æµ‹æ€§èƒ½

**å½±å“**ï¼šâœ… æ— å½±å“æˆ–ç•¥æœ‰æå‡

- è¿›åº¦æ¡åˆ·æ–°ï¼šæ¯ 0.1 ç§’æ›´æ–°ä¸€æ¬¡ï¼Œå¯¹æ€§èƒ½å½±å“å¯å¿½ç•¥
- ä»·æ ¼ç±»å‹é€‰æ‹©ï¼šä¸å½±å“æ€§èƒ½
- è°ƒä»“é¢‘ç‡é…ç½®ï¼šä¸å½±å“æ€§èƒ½
- è¯¦ç»†æ—¥å¿—å¼€å…³ï¼šå…³é—­æ—¶å¯ç•¥å¾®æå‡æ€§èƒ½

### æµ‹è¯•æ€§èƒ½

**å½±å“**ï¼šâœ… ç•¥æœ‰æå‡

- ä½¿ç”¨ä¸´æ—¶ç›®å½•ï¼šæµ‹è¯•è¿è¡Œæ›´å¿«ï¼ˆæ— éœ€æ¸…ç†çœŸå®æ•°æ®ï¼‰
- ç‹¬ç«‹æµ‹è¯•ï¼šå¹¶è¡Œæµ‹è¯•æ›´å®‰å…¨

---

## é£é™©è¯„ä¼°

### å·²çŸ¥é£é™©

1. **ä»·æ ¼å£å¾„è¿ç§»**
   - **é£é™©**ï¼šä½¿ç”¨ä¸åŒä»·æ ¼ç±»å‹å¯èƒ½å¯¼è‡´å›æµ‹ç»“æœå·®å¼‚
   - **ç¼“è§£**ï¼šæä¾›è¯¦ç»†æ–‡æ¡£å’Œè¿ç§»æŒ‡å—
   - **éªŒè¯**ï¼šå»ºè®®å…ˆåœ¨å°èŒƒå›´æµ‹è¯•ï¼Œå¯¹æ¯”å·®å¼‚

2. **è°ƒä»“é¢‘ç‡æ‰©å±•**
   - **é£é™©**ï¼šæ•´æ•°å‚æ•°å¯èƒ½è¢«è¯¯ç”¨ï¼ˆå¦‚ rebalance_freq=0ï¼‰
   - **ç¼“è§£**ï¼šæ·»åŠ å‚æ•°æ ¡éªŒå’Œæ¸…æ™°çš„é”™è¯¯æç¤º
   - **éªŒè¯**ï¼šæµ‹è¯•è¦†ç›–è¾¹ç•Œæƒ…å†µ

### æµ‹è¯•è¦†ç›–

- **å•å…ƒæµ‹è¯•**ï¼š101 ä¸ªæµ‹è¯•å…¨éƒ¨é€šè¿‡
- **é›†æˆæµ‹è¯•**ï¼šç°æœ‰æµ‹è¯•ç»§ç»­é€šè¿‡
- **è¾¹ç•Œæµ‹è¯•**ï¼šæ–°å¢æµ‹è¯•è¦†ç›–è¾¹ç•Œæƒ…å†µ

---

## åç»­è®¡åˆ’

### çŸ­æœŸï¼ˆ1-2å‘¨ï¼‰

1. å®ç° IC ä¼˜åŒ–æŒ‡å—ä¸­çš„çŸ­æœŸä¼˜åŒ–æªæ–½
2. æ·»åŠ å›æµ‹æŠ¥å‘Šä¸­çš„ä»·æ ¼ç±»å‹è¯´æ˜
3. å®Œå–„å‘½ä»¤è¡Œå‚æ•°æ–‡æ¡£

### ä¸­æœŸï¼ˆ2-4å‘¨ï¼‰

1. å®ç°ç‰¹å¾é¢„å¤„ç†æ¨¡å—ï¼ˆå»æå€¼ã€æ ‡å‡†åŒ–ã€ä¸­æ€§åŒ–ï¼‰
2. æ·»åŠ  IC/RankIC ç›‘æ§ä»ªè¡¨æ¿
3. ä¼˜åŒ–å›æµ‹æ€§èƒ½

### é•¿æœŸï¼ˆ1-2æœˆï¼‰

1. å®ç°å› å­åº“
2. å®ç°é›†æˆå­¦ä¹ æ¡†æ¶
3. æ·»åŠ å®ç›˜æ¥å£

---

## æ€»ç»“

æœ¬ PR å®Œæˆäº†ä»¥ä¸‹å·¥ä½œï¼š

âœ… **5 ä¸ªæ ¸å¿ƒé—®é¢˜å…¨éƒ¨è§£å†³**
âœ… **7 ä¸ªæ–‡ä»¶ä¿®æ”¹/æ–°å¢**
âœ… **2 ç¯‡è¯¦ç»†æ–‡æ¡£ï¼ˆå…± 21,403 å­—ç¬¦ï¼‰**
âœ… **14 ä¸ªæ–°å¢æµ‹è¯•ç”¨ä¾‹**
âœ… **101 ä¸ªæµ‹è¯•å…¨éƒ¨é€šè¿‡**
âœ… **å®Œå…¨å‘åå…¼å®¹**

æ‰€æœ‰ä»£ç ã€æ³¨é‡Šã€æ–‡æ¡£å‡ä½¿ç”¨ä¸­æ–‡ï¼Œç¬¦åˆé¡¹ç›®è§„èŒƒã€‚

---

## éªŒè¯æ¸…å•

åœ¨åˆå¹¶ PR å‰ï¼Œè¯·éªŒè¯ï¼š

- [ ] æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼š`pytest tests/ -v`
- [ ] ä»£ç æ ¼å¼ç¬¦åˆè§„èŒƒï¼š`black src/ tests/`
- [ ] å¯¼å…¥æ’åºæ­£ç¡®ï¼š`isort src/ tests/`
- [ ] æ— ä»£ç æ£€æŸ¥é”™è¯¯ï¼š`flake8 src/ tests/`
- [ ] æ–‡æ¡£é“¾æ¥æ­£ç¡®
- [ ] README æ›´æ–°å®Œæ•´
- [ ] å‘åå…¼å®¹æ€§ç¡®è®¤

---

## è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æäº¤ Issue æˆ–è”ç³»ç»´æŠ¤è€…ã€‚

æ„Ÿè°¢ä½¿ç”¨ LazyBullï¼
